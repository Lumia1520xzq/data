<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//ibatis.apache.org//DTD Mapper 3.0//EN"
"http://ibatis.apache.org/dtd/ibatis-3-mapper.dtd">


<mapper namespace="com.wf.data.dao.fish.RoomFishInfoDao">

	<!-- 捕鱼的投注信息 -->
	<select id="findBettingInfoByDate" statementType="STATEMENT" resultType="com.wf.data.dao.data.entity.ReportGameInfo">
		SELECT
		<choose>  
            <when test="searchType ==1">
               DATE_FORMAT(t.create_time,'%Y-%m-%d %H') search_date,
            </when>  
            <otherwise>  
               DATE_FORMAT(t.create_time,'%Y-%m-%d') search_date,
            </otherwise>  
        </choose>  
		IFNULL(COUNT(DISTINCT user_id),0) cathectic_user_num,  -- 投注人数
		IFNULL(COUNT(user_id),0) cathectic_num, -- 投注笔数
		IFNULL(SUM(t.amount),0) cathectic_money, -- 投注流水
		IFNULL(SUM(t.return_amount),0) win_money -- 返奖流水
		FROM ${tableName}  t
		WHERE 1=1
		AND t.delete_flag = 0
		<if test="parentId != null">
			AND t.channel_id LIKE CONCAT( ${parentId}, '%')
		</if>
		<if test="channelId != null">
			AND t.channel_id = ${channelId}
		</if>
		<if test="userIds != null and  userIds.size() != 0">
	        AND t.user_id not in
	     <foreach collection="userIds" index="index" item="item" open="(" separator="," close=")">
		    ${item}
	     </foreach>
	    </if>
		AND t.create_time BETWEEN '${beginDate}' AND '${endDate}'
		<choose>  
            <when test="searchType ==1">  
               GROUP BY DATE_FORMAT(t.create_time,'%Y-%m-%d %H')
            </when>  
            <otherwise>  
               GROUP BY DATE_FORMAT(t.create_time,'%Y-%m-%d')
            </otherwise>  
        </choose>  
	</select>
	
	
	<!-- 捕鱼的投注用户 -->
	<select id="findBettingUsersByDate" statementType="STATEMENT" resultType="Long">
		SELECT DISTINCT user_id
		FROM ${tableName}  t
		WHERE 1=1
		AND t.delete_flag = 0
		<if test="parentId != null">
			AND t.channel_id LIKE CONCAT( ${parentId}, '%')
		</if>
		<if test="channelId != null">
			AND t.channel_id = ${channelId}
		</if>
		<if test="userIds != null and  userIds.size() != 0">
	        AND t.user_id not in
	     <foreach collection="userIds" index="index" item="item" open="(" separator="," close=")">
		    ${item}
	     </foreach>
	    </if>
		AND t.create_time BETWEEN '${beginDate}' AND '${endDate}'
	</select>


	<select id="findFishDateByDate" statementType="STATEMENT" resultType="com.wf.data.dao.data.entity.ReportFishBettingInfo">
		SELECT
		t.user_id userId,
		t.channel_id channelId,
		t.fish_config_id fishConfigId,
		t.amount amount,
		IFNULL(COUNT(t.user_id),0) bettingCount,
		IFNULL(SUM(t.amount),0) bettingAmount,
		IFNULL(SUM(t.return_amount),0) resultAmount
		FROM ${tableName}  t
		WHERE 1=1
		<if test="parentId != null">
			AND t.channel_id LIKE CONCAT( ${parentId}, '%')
		</if>
		<if test="channelId != null">
			AND t.channel_id = ${channelId}
		</if>
		AND t.create_time BETWEEN '${beginDate}' AND '${endDate}'
		GROUP BY channel_id,user_id ,fish_config_id,amount
	</select>
</mapper>

