<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//ibatis.apache.org//DTD Mapper 3.0//EN"
"http://ibatis.apache.org/dtd/ibatis-3-mapper.dtd">

<mapper namespace="com.wf.data.dao.mycat.UicUserDao">
	<sql id="uicUserGroupWhere">
		t.delete_flag = #{DEL_FLAG_NORMAL}
		<if test="p.loginname != null and p.loginname !=''">
			AND t.loginname LIKE CONCAT('%', #{p.loginname}, '%')
		</if>
		<if test="p.nickname != null and p.nickname != ''">
			AND t.nickname LIKE CONCAT('%', #{p.nickname}, '%')
		</if>
      	<if test="p.regChannelId != null and p.regChannelId != ''">
			AND t.reg_channel_id LIKE CONCAT('%', #{p.regChannelId}, '%')
		</if> 
      	<if test="p.groupTypeId != null">
      		AND t2.group_type_id = #{p.groupTypeId}
		</if> 
	</sql>
	
	
	<select id="getUserByLoginname" resultType="UicUser">
		SELECT <include refid="uicUserColumns"/> FROM uic_user t WHERE loginname = #{loginname} and delete_flag = 0
	</select>
	
	<select id="getByUserId" resultType="UicUser">
		SELECT <include refid="uicUserColumns"/> FROM uic_user t WHERE id = #{userId}
	</select>
	
	<select id="getUserByThird" resultType="UicUser">
		SELECT <include refid="uicUserColumns"/> FROM uic_user t WHERE third_id = #{thirdId} AND user_source = #{userSource} and delete_flag = 0
		ORDER BY ID ASC LIMIT 1
	</select>
	<select id="getByNickname" resultType="UicUser">
		SELECT <include refid="uicUserColumns"/> FROM uic_user t WHERE nickname = #{nickname} AND delete_flag = 0
		ORDER BY ID ASC LIMIT 1
	</select>
	
	<select id="getByPhone" resultType="UicUser">
		SELECT <include refid="uicUserColumns"/> FROM uic_user t WHERE phone = #{phone} AND delete_flag = 0
		ORDER BY ID ASC LIMIT 1
	</select>
	
	<select id="getByChannelId" resultType="UicUser">
		SELECT distinct u1.*  
		FROM `uic_user` u1 JOIN `uic_user_log` u2
		ON u1.id = u2.user_id
		WHERE 1=1 
		<if test="p.loginname != null and p.loginname !=''">
			AND u1.loginname LIKE CONCAT('%', #{p.loginname}, '%')
		</if>
		<if test="p.nickname != null and p.id == null">
			AND u1.nickname LIKE CONCAT('%', #{p.nickname}, '%')
		</if>
		<if test="p.nickname != null and p.id != null">
			AND (u1.nickname LIKE CONCAT('%', #{p.nickname}, '%') OR u1.id = #{p.id})
		</if>
		<if test="p.channelId != null and p.channelId != ''">
			AND u2.channel_id LIKE CONCAT('%', #{p.channelId}, '%')
		</if> 
	</select>
	
	<select id="findList2" resultType="UicUser">
		SELECT <include refid="uicUserColumns"/> 
		FROM uic_user t
		left join uic_group t2
		on t.id = t2.user_id
		WHERE <include refid="uicUserGroupWhere"/> 
		ORDER BY id desc LIMIT #{start}, #{length}
	</select>
	<select id="count2" resultType="long">
		SELECT COUNT(*)
		FROM uic_user t
		left join uic_group t2
		on t.id = t2.user_id
		WHERE <include refid="uicUserGroupWhere"/> 
	</select>


	<select id="getUserByInvitationCode" resultType="UicUser">
		SELECT <include refid="uicUserColumns"/>
		FROM uic_user t
		WHERE t.invitation_code = #{invitationCode} AND delete_flag = 0
		ORDER BY ID DESC LIMIT 1
	</select>

	<select id="getByParentInvitationCode" resultType="UicUser">
		SELECT <include refid="uicUserColumns"/> FROM uic_user t WHERE parent_invitation_code = #{parentInvitationCode} AND delete_flag = 0
	</select>
</mapper>

